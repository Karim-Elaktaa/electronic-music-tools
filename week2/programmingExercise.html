<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
	<head>
		<script src="ext/nexusUI.js"></script>
		<meta http-equiv="content-type" context="text/html"; charset=utf-8">
		<title>Electronic Music Tools</title>
	</head>


<body>
	<div id="main">

		<div style="width:840px; height:320px; display:block;">
			<div> ... </div>
			<canvas class="visuAnalyser" 
					width="840" height="320px">
			</canvas>
		</div>

		<div id="osc1" class="oscFrame">
			<div class="pair">
				<canvas id="toggleStartOsc1" nx="toggle" class="lower-control"
						height="65px" width="65px">
				</canvas>
				<div>On</div>
			</div>
		
			<div class="pair">
				<canvas id="selectTypeOsc1" nx="select" width="300px"
						choices="sine,square,sawtooth,triangle" ></canvas>
				<div>Oscillator type</div>
			</div>
		
			<div id="firstOscManager">
				<canvas id="sliderOsc1" nx="slider"
						min="100" max="1000"></canvas>
			
				<canvas id="keyboardOsc1" nx="keyboard"
						height="100px" width="500px"></canvas>
			</div>
		</div>

		<div id="osc2" class="oscFrame">
			<div class="pair">
				<canvas id="toggleStartOsc2" nx="toggle" class="lower-control"
						height="65px" width="65px">
				</canvas>
				<div>On</div>
			</div>
		
			<div class="pair">
				<canvas id="gainOsc2" nx="dial" class="lower-control"
						></canvas>
				<div>Gain</div>
			</div>
	
			<div class="pair">
				<canvas id="delayOsc2" nx="dial" class="lower-control"
						></canvas>
				<div>Delay</div>
			</div>

			<div class="pair">
				<canvas id="Osc2" nx="dial" class="lower-control"
						></canvas>
				<div>Delay</div>
			</div>

			<div>
				<canvas id="sliderOsc2" nx="slider"
						min="100" max="1000"></canvas>
				<canvas nx="position"></canvas>
			</div>
		</div>

	</div>
</body>

<script>
/////////////////////////////////////
/////////////////////////////////////
// User Interface
/////////////////////////////////////
/////////////////////////////////////

	var sliderOsc1;
	var keyboardOsc1;
	var toggleStartOsc1;
	var selectTypeOsc1;

	var toggleStartOsc2;
	var sliderOsc2;

	nx.onload = function() {
		nx.colorize("accent", "#347");
        nx.colorize("border", "#bbb");
        nx.colorize("fill", "#eee");

		toggleStartOsc1.on('*', updateStartUIOsc1);
		sliderOsc1.on('*', updateSliderUIOsc1);
		keyboardOsc1.on('*', updateKeyboardUIOsc1);
		selectTypeOsc1.on('*', updateOscTypeUIOsc1);


		toggleStartOsc2.on('*', updateStartUIOsc2);
		sliderOsc2.on('*', updateSliderUIOsc2);
	};

	///////////////////////
	// OSC 1
	///////////////////////
	function updateStartUIOsc1(data) {
		if (data.value == true) {
			startOscillators(1);
		} else {
			stopOscillators(1);
		}
	}

	function updateSliderUIOsc1(data) {
		// update osc frequency
		updateOscFreq(1, data.value);
	}

	function updateOscTypeUIOsc1(data) {
		// update osc type
		updateTypeOfOsc(1, data.text);
	}

	function updateKeyboardUIOsc1(data) {
		// update osc frequency
		updateOscFreq(1, midi_to_freq[data.note]);
		// update UI
		forceSliderUpdate(1, midi_to_freq[data.note]);
	}


	///////////////////////
	// OSC 2
	///////////////////////
	function updateStartUIOsc2(data) {
		if (data.value == true) {
			startOscillators(2);
		} else {
			stopOscillators(2);
		}
	}

	function updateSliderUIOsc2(data) {
		// update osc frequency
		updateOscFreq(2, data.value);
	}

	///////////////////////
	// COMMON
	///////////////////////
	function forceSliderUpdate(targetOsc, data) {
		// force slider update
		switch (targetOsc) {
			case 1:
				sliderOsc1.set({value:data}, true);
				break;
			case 2:
				sliderOsc1.set({value:data}, true);
				break;
		}
	}

</script>

<script>
/////////////////////////////////////
/////////////////////////////////////
// Audio Management
/////////////////////////////////////
/////////////////////////////////////

	var audio_context = window.AudioContext
			|| window.webkitAudioContext;
	var con = new audio_context();
	var osc;
	var osc2;
	var amp;
	var typeOfOsc1 = 'sine';
	var typeOfOsc2 = 'sine';
	var oscOn = [false, false];

	var analyser = con.createAnalyser();
	analyser.fftSize = 2048;
	
	var visuAnalyser = document.querySelector('.visuAnalyser');
	var visuAnalyserCtx = visuAnalyser.getContext("2d");
	var drawVisual;

	function updateOscFreq(oscTarget, freq) {
		switch (oscTarget) {
			case 1:
				try {
					osc.frequency.value = freq;
				} catch (e) {
					logError(e);
				}
				break;
			case 2:
				try {
					osc2.frequency.value = freq;
				} catch (e) {
					logError(e);
				}
				break;
		}
	}

	function updateTypeOfOsc(oscTarget, value) {
		typeOfOsc1 = value;
		try {
			osc.type = typeOfOsc1;
		} catch (e) {
			logError(e);
		}
	}

	function visualize() {
		WIDTH = visuAnalyser.width;
		HEIGHT = visuAnalyser.height;

		analyser.fftSize = 2048;
		var bufferLength = analyser.fftSize;
		var dataArray = new Uint8Array(bufferLength);
		console.log(dataArray);

		visuAnalyserCtx.clearRect(0, 0, WIDTH, HEIGHT);

		function draw() {
			drawVisual = requestAnimationFrame(draw);
			analyser.getByteTimeDomainData(dataArray);

			visuAnalyserCtx.fillStyle = 'rgb(200, 200, 200)';
			visuAnalyserCtx.fillRect(0, 0, WIDTH, HEIGHT);

			visuAnalyserCtx.lineWidth = 2;
			visuAnalyserCtx.strokeStyle = 'rgb(0, 0, 0)';

			visuAnalyserCtx.beginPath();

			var sliceWidth = WIDTH * 1.0 / bufferLength;
			var x = 0;

			for(var i = 0; i < bufferLength; i++) {
				var v = dataArray[i] / 128.0;
				var y = v * HEIGHT / 2;

				if (i === 0) {
					visuAnalyserCtx.moveTo(x, y);
				} else {
					visuAnalyserCtx.lineTo(x, y);
				}

				x += sliceWidth;
			}

			visuAnalyserCtx.lineTo(visuAnalyser.width, visuAnalyser.height / 2);
			visuAnalyserCtx.stroke();

		};

		draw();
	}

	function startOscillators(oscTarget) {
		switch (oscTarget) {
			case 1:
				// create gain
				amp = con.createGain();
				amp.gain.value = 0;
		
				// create oscillator
				osc = con.createOscillator();
				osc.type = typeOfOsc1;
				osc.frequency.value = Math.random() * 500;
		
				var now = con.currentTime;
		
				amp.gain.linearRampToValueAtTime(0.5, now + 9);
				amp.gain.linearRampToValueAtTime(0.2, now + 14);
		
				osc.connect(amp);
				amp.connect(analyser);
				analyser.connect(con.destination);
		
				osc.start();
				// update slider
				forceSliderUpdate(oscTarget, osc.frequency.value);

				oscOn[0] = true;

				visualize();
				break;
			case 2:
				// create oscillator
				osc2 = con.createOscillator();
				osc2.type = typeOfOsc2;
				osc2.frequency.value = Math.random() * 500;
		
				var now = con.currentTime;
		
				osc2.connect(con.destination);
		
				osc2.start();
				// update slider
				forceSliderUpdate(oscTarget, osc.frequency.value);

				oscOn[1] = true;
				break;

		}
	}

	function stopOscillators(oscTarget) {
		switch (oscTarget) {
			case 1:
				try {
					osc.stop();
				} catch (e) {
					logError(e);
				}
				break;
		case 2:
				try {
					osc2.stop();
				} catch (e) {
					logError(e);
				}
				break;

		}
	}

	function changeGainValue() {
		try {
			amp.gain.value = 0;
		} catch (e) {
			logError(e);
		}
	}

	function changeGainTempo() {
		try {
			amp.gain.linearRampToValueAtTime(0, now + 4);
			amp.gain.value = 0;
		} catch (e) {
			logError(e);
		}
	}

	function playSynth() {
		var osc = con.createOscillator();
		osc.type = 'sine';

		var amp = con.createGain();

		osc.frequency.value = Math.random() * 500;
		osc.connect(amp);

		var now = con.currentTime;

		amp.gain.value = 0;
		amp.gain.linearRampToValueAtTime(0.1, now + 2);
		amp.gain.linearRampToValueAtTime(0, now + 4);

		amp.connect(con.destination);
		osc.start();

		osc.stop(now + 4.1);
	}
</script>

<script>
/////////////////////////////////////
/////////////////////////////////////
// Utils
/////////////////////////////////////
/////////////////////////////////////

	var DEBUG = true;

	var midi_to_freq = {
		48:130.8127826503,
		49:138.5913154884,
		50:146.8323839587,
		51:155.5634918610,
		52:164.8137784564,
		53:174.6141157165,
		54:184.9972113558,
		55:195.9977179909,
		56:207.6523487900,
		57:220.0000000000,
		58:233.0818807590,
		59:246.9416506281,
		60:261.63,
		61:277.18,
		62:293.66,
		63:311.13,
		64:329.63,
		65:349.23,
		66:369.99,
		67:392.00,
		68:415.30,
		69:440.0000000000,
		70:466.1637615181,
		71:493.8833012561,
		72:523.2511306012,
		73:554.3652619537,
		74:587.3295358348,
		75:622.2539674442,
		76:659.2551138257,
		77:698.4564628660,
		78:739.9888454233,
		79:783.9908719635,
		80:830.6093951599,
		81:880.0000000000,
		82:932.3275230362,
		83:987.7666025122
	};

	function logError(e) {
		if (DEBUG) {
			console.log(e);
		}
	}
</script>

<style>
	body {
		margin:0;
		padding:0;
	}
	#main {
		width: 800px;
		margin:30px auto;
	}
	.lower-control {
		height:65px;
		width:65px;
		display:block;
	}
	.pair {
		display:inline-block;
		margin:10px 5px;
	}
	.pair div {
		text-align:center;
		font-family:helvetica;
		font-size:9pt;
		font-weight:500;
		color:#aaa;
		margin:10px 0px;
	}
	.oscFrame {
		border: 3px #ededed solid;
		padding:10px 10px;
		margin:2px 5px;
		border-radius: 25px;
	}
</style>

</html>
